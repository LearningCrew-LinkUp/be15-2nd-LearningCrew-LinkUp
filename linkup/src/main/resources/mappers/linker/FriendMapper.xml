<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.learningcrew.linkup.linker.query.mapper.FriendMapper">
    <!-- 수락된 친구 목록 조회 -->
    <select id="findAcceptedFriends" resultType="FriendInfoDTO">
        SELECT
            CASE
                WHEN f.requester_id = #{memberId} THEN f.adressee_id
                ELSE f.requester_id
                END AS friendId,
            m.nickname,
            m.profile_image_url,
            f.responded_at AS connectedAt
        FROM friend f
                 JOIN member m
                      ON (m.member_id = CASE
                                            WHEN f.requester_id = #{memberId} THEN f.adressee_id
                                            ELSE f.requester_id
                          END)
        WHERE (f.requester_id = #{memberId} OR f.adressee_id = #{memberId})
          AND f.status_id = (
            SELECT status_id FROM status WHERE status_type = 'ACCEPTED'
        )
    </select>

    <!-- 받은 친구 요청 조회 -->
    <select id="findIncomingFriendRequests" resultType="FriendRequestStatusDTO">
        SELECT
            f.requester_id AS adresseeId,
            m.nickname,
            s.status_type AS status,
            f.requested_at
        FROM friend f
                 JOIN member m ON f.requester_id = m.member_id
                 JOIN status s ON f.status_id = s.status_id
        WHERE f.adressee_id = #{memberId}
          AND s.status_type = 'PENDING'
    </select>

    <!-- 보낸 친구 요청 조회 -->
    <select id="findOutgoingFriendRequests" resultType="FriendRequestStatusDTO">
        SELECT
            f.adressee_id,
            m.nickname,
            s.status_type AS status,
            f.requested_at
        FROM friend f
                 JOIN member m ON f.adressee_id = m.member_id
                 JOIN status s ON f.status_id = s.status_id
        WHERE f.requester_id = #{memberId}
          AND s.status_type = 'PENDING'
    </select>

    <!-- 친구 요청 존재 여부 -->
    <select id="existsFriendRequest" resultType="boolean">
        SELECT COUNT(*)
        FROM friend
        WHERE requester_id = #{requesterId}
          AND adressee_id = #{adresseeId}
    </select>

</mapper>
